<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Organization Manager • Bootstrap 5 + jQuery + JWT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background: #f7f7fb
        }

        .panel {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .06);
        }

        .pointer {
            cursor: pointer
        }

        .chip {
            display: inline-block;
            padding: .25rem .5rem;
            border-radius: 999px;
            background: #f1f3f5;
            font-size: .8rem
        }

        .chip.admin {
            background: #ffe3e3
        }

        .chip.analyst {
            background: #e7f5ff
        }

        .chip.viewer {
            background: #e6fcf5
        }
    </style>
</head>
<body>
{% include 'partials/navbar.html' %}

<main class="container py-4">
    <!-- Toolbar -->
    <div class="panel p-3 mb-3">
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-primary" id="newOrgBtn">+ New Organization</button>
            <div class="ms-auto input-group" style="max-width:380px">
                <span class="input-group-text">Search</span>
                <input id="searchBox" class="form-control" placeholder="name, slug, owner"/>
            </div>
        </div>
    </div>

    <!-- Grid -->
    <div class="panel p-0">
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead class="table-light">
                <tr>
                    <th style="width:60px">#</th>
                    <th>Name</th>
                    <th style="width:60px">Logo</th>
                    <th>Industry</th>
                    <th>Contact Email</th>
                    <th>Phone</th>
                    <th style="width:220px">Actions</th>
                </tr>
                </thead>
                <tbody id="orgTable"></tbody>
            </table>
        </div>
        <div class="p-3 d-flex justify-content-between border-top">
            <div class="text-muted small" id="orgCount">0 organizations</div>
            <div class="btn-group">
                <button class="btn btn-outline-secondary btn-sm" id="prevPage">Prev</button>
                <button class="btn btn-outline-secondary btn-sm" id="nextPage">Next</button>
            </div>
        </div>
    </div>
</main>

<!-- Create/Edit Org Modal -->
<div class="modal fade" id="orgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="orgModalTitle">New Organization</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="orgForm" class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="orgName" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Company Logo</label>
                        <input type="file" class="form-control" id="orgLogo" accept="image/*">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Industry</label>
                        <input type="text" class="form-control" id="orgIndustry" placeholder="e.g., Healthcare">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Contact Email</label>
                        <input type="email" class="form-control" id="orgEmail" placeholder="contact@example.com">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" id="orgPhone" placeholder="+1 555 123 4567">
                    </div>
                </form>
                <!-- Members removed -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveOrgBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Login</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-control" id="loginUsername" placeholder="admin"/>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" placeholder="••••••••"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="loginBtn" class="btn btn-primary">Login</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="toast" class="toast">
        <div class="toast-header"><strong class="me-auto" id="toastTitle">Notice</strong>
            <button class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastBody">Hello</div>
    </div>
</div>

<script>
    // ================= CONFIG =================
    const API_BASE = "http://localhost:8000"; // change this if needed
    const ENDPOINTS = {
        token: API_BASE + "/api/token/",
        // orgs (list/create) — existing API under /api/v1/orgs/
        orgs: API_BASE + "/api/v1/orgs/",
        // The following endpoints are not implemented in the backend yet; avoid calling them
        orgDetail: (id) => API_BASE + "/api/v1/orgs/" + id + "/",
        members: (orgId) => API_BASE + "/api/v1/orgs/" + orgId + "/members/",
        memberDetail: (orgId, memberId) => API_BASE + "/api/v1/orgs/" + orgId + "/members/" + memberId + "/",
    };

    // ================= UTIL =================
    function notify(title, body) {
        $('#toastTitle').text(title);
        $('#toastBody').text(body);
        new bootstrap.Toast('#toast').show();
    }

    function getToken() {
        return localStorage.getItem('access');
    }

    function setTokens(a, r) {
        localStorage.setItem('access', a);
        localStorage.setItem('refresh', r || '');
        setAuthUI(true);
    }

    function clearTokens() {
        localStorage.removeItem('access');
        localStorage.removeItem('refresh');
        setAuthUI(false);
    }

    function setAuthUI(ok) {
        if (ok) {
            $('#authStatus').removeClass('text-warning').addClass('text-success').text('Authenticated');
            $('#logoutBtn').removeClass('d-none');
        } else {
            $('#authStatus').removeClass('text-success').addClass('text-warning').text('Not authenticated');
            $('#logoutBtn').addClass('d-none');
        }
    }

    function ajaxAuth(opts) {
        const t = getToken();
        opts.headers = opts.headers || {};
        if (t) opts.headers['Authorization'] = 'Bearer ' + t;
        return $.ajax(opts).fail((xhr) => {
            if (xhr.status === 401) notify('Auth', 'Unauthorized'); else notify('Error ' + xhr.status, xhr.responseText || 'Request failed');
        });
    }

    function safeJSON(s) {
        try {
            return JSON.parse(s || '{}');
        } catch (e) {
            notify('JSON', 'Invalid JSON, using {}');
            return {};
        }
    }

    // ================= STATE =================
    let ORGS = []; // list page cache
    let PAGE = 1;
    let PAGE_SIZE = 10; // naive pager (adjust to your API)
    let CURRENT_ORG = null; // object with members list

    // ================= AUTH =================
    $('#loginBtn').on('click', function () {
        const username = $('#loginUsername').val().trim();
        const password = $('#loginPassword').val();
        $.ajax({
            url: ENDPOINTS.token,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({username, password})
        }).done((d) => {
            setTokens(d.access, d.refresh);
            notify('Login', 'Authenticated');
            bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
            loadOrgs();
        }).fail(() => notify('Login', 'Invalid credentials'));
    });
    $('#logoutBtn').on('click', function () {
        clearTokens();
        $('#orgTable').empty();
        $('#orgCount').text('0 organizations');
    });
    setAuthUI(!!getToken());
    if (getToken()) loadOrgs();

    // ================= ORG LIST =================
    function loadOrgs() {
        const search = ($('#searchBox').val() || '').trim();
        const params = `?page=${PAGE}&page_size=${PAGE_SIZE}&search=${encodeURIComponent(search)}`;
        ajaxAuth({ url: ENDPOINTS.orgs + params, method: 'GET' }).done((data) => {
            const results = data.results || [];
            const count = data.count || 0;
            ORGS = results;
            $('#orgTable').empty();
            results.forEach(renderOrgRow);
            $('#orgCount').text(`${count} organizations`);
            // Toggle prev/next buttons
            $('#prevPage').prop('disabled', PAGE <= 1);
            $('#nextPage').prop('disabled', (PAGE * PAGE_SIZE) >= count);
        });
    }

    function renderOrgRow(org) {
        const tr = $(`<tr data-id="${org.id}">
  <td>${org.id}</td>
  <td class="fw-semibold">${org.name}</td>
  <td><img src="${org.logo || ''}" alt="" style="height:28px"/></td>
  <td>${org.industry || ''}</td>
  <td>${org.contact_email || ''}</td>
  <td>${org.phone || ''}</td>
  <td>
    <div class="btn-group btn-group-sm">
      <button class="btn btn-outline-primary edit-org">Edit</button>
      <a class="btn btn-outline-info" href="/dashboard/${org.id}">Dashboard</a>
      <a class="btn btn-outline-secondary" href="/users/${org.id}">Users</a>
      <button class="btn btn-outline-danger delete-org">Delete</button>
    </div>
  </td>
</tr>`);
        $('#orgTable').append(tr);
    }

    $('#searchBox').on('input', function () {
        PAGE = 1;
        loadOrgs();
    });
    $('#prevPage').on('click', function () { if (PAGE > 1) { PAGE--; loadOrgs(); } });
    $('#nextPage').on('click', function () { PAGE++; loadOrgs(); });

    // ================= NEW / EDIT ORG =================
    $('#newOrgBtn').on('click', function () {
        CURRENT_ORG = null;
        $('#orgModalTitle').text('New Organization');
        $('#orgName').val('');
        $('#orgIndustry').val('');
        $('#orgEmail').val('');
        $('#orgPhone').val('');
        new bootstrap.Modal('#orgModal').show();
    });

    $(document).on('click', '.edit-org', function () {
        const id = $(this).closest('tr').data('id');
        // Backend currently lacks org detail; emulate by finding in ORGS
        const org = (ORGS || []).find(o => o.id === id);
        if (!org) return notify('Org', 'Not found in current page');
        CURRENT_ORG = org;
        $('#orgModalTitle').text('Edit Organization #' + org.id);
        $('#orgName').val(org.name || '');
        $('#orgIndustry').val(org.industry || '');
        $('#orgEmail').val(org.contact_email || '');
        $('#orgPhone').val(org.phone || '');
        $('#memberTable').empty(); // members endpoints not available
        new bootstrap.Modal('#orgModal').show();
    });

    $(document).on('click', '.delete-org', function () {
        const id = $(this).closest('tr').data('id');
        if (!confirm('Delete organization #' + id + ' ?')) return;
        ajaxAuth({ url: ENDPOINTS.orgDetail(id), method: 'DELETE' })
          .done(()=>{ notify('Org', 'Deleted #' + id); loadOrgs(); })
          .fail((xhr)=>{
            let msg = 'Request failed';
            if (xhr && xhr.responseJSON) msg = xhr.responseJSON.detail || JSON.stringify(xhr.responseJSON);
            else if (xhr && xhr.responseText) msg = xhr.responseText;
            notify('Org Error', msg);
          });
    });

    $('#saveOrgBtn').on('click', function () {
        const name = $('#orgName').val().trim();
        if (!name) return notify('Validation', 'Name is required');
        const file = $('#orgLogo')[0].files[0];
        const form = new FormData();
        form.append('name', name);
        const industry = $('#orgIndustry').val().trim();
        const email = $('#orgEmail').val().trim();
        const phone = $('#orgPhone').val().trim();
        if (industry) form.append('industry', industry);
        if (email) form.append('contact_email', email);
        if (phone) form.append('phone', phone);
        if (file) form.append('logo', file);
        const isEdit = !!CURRENT_ORG;
        const url = isEdit ? ENDPOINTS.orgDetail(CURRENT_ORG.id) : ENDPOINTS.orgs;
        const method = isEdit ? 'PATCH' : 'POST';
        ajaxAuth({ url, method, processData:false, contentType:false, data: form })
          .done((org)=>{ notify('Org', (isEdit?'Updated #':'Created #') + org.id); loadOrgs(); CURRENT_ORG = org; try{ bootstrap.Modal.getInstance(document.getElementById('orgModal')).hide(); }catch(e){} })
          .fail((xhr)=>{
            let msg = 'Request failed';
            if (xhr && xhr.responseJSON) msg = xhr.responseJSON.detail || JSON.stringify(xhr.responseJSON);
            else if (xhr && xhr.responseText) msg = xhr.responseText;
            notify('Org Error', msg);
          });
    });

    // ================= MEMBERS =================
    function loadMembers(orgId) {
        // Not available in backend yet
        $('#memberTable').empty();
    }

    function renderMemberRow(m) {
        const tr = $(`<tr data-member-id="${m.id}"><td>${m.username || m.user || m.user_id}</td><td><span class="chip ${m.role}">${m.role}</span></td><td class="text-end"><div class="btn-group btn-group-sm"><button class="btn btn-outline-secondary change-role">Role</button><button class="btn btn-outline-danger remove-member">Del</button></div></td></tr>`);
        $('#memberTable').append(tr);
    }

    $('#addMemberBtn').on('click', function () {
        if (!CURRENT_ORG) return notify('Org', 'Save org first');
        const user = $('#memberUser').val().trim();
        const role = $('#memberRole').val();
        if (!user) return notify('Members', 'Provide user');
        notify('Members', 'Members API not available');
    });

    $(document).on('click', '.remove-member', function () {
        const row = $(this).closest('tr');
        const memberId = row.data('member-id');
        if (!confirm('Remove member #' + memberId + ' ?')) return;
        notify('Members', 'Members API not available');
    });

    $(document).on('click', '.change-role', function () {
        const row = $(this).closest('tr');
        const memberId = row.data('member-id');
        const newRole = prompt('New role: admin / analyst / viewer', 'viewer');
        if (!newRole) return;
        notify('Members', 'Members API not available');
    });

</script>
</body>
</html>
