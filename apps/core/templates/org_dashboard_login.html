<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Organization Dashboard Login</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background:#f7f7fb }
    .card { border:0; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08) }
  </style>
  <meta name="referrer" content="no-referrer-when-downgrade"/>
  <meta http-equiv="Cache-Control" content="no-store"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="color-scheme" content="light dark"/>
  <meta name="theme-color" content="#0d6efd"/>
  <meta name="format-detection" content="telephone=no"/>
</head>
<body>
<main class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card p-4 p-md-5">
        <h4 class="mb-3">Organization Login</h4>
        <p class="text-muted">Sign in to access your organization dashboard.</p>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" id="email" placeholder="you@company.com">
        </div>
        <div class="mb-3">
          <label class="form-label">Password</label>
          <input type="password" class="form-control" id="password" placeholder="••••••••">
        </div>
        <button class="btn btn-primary w-100" id="loginBtn">Sign In</button>
        <div class="text-danger small mt-3 d-none" id="loginError"></div>
      </div>
    </div>
  </div>
</main>

<script>
// Minimal JWT login against existing API (expects /api/token/ endpoint) and redirects to first org dashboard
const API_BASE = "http://127.0.0.1:8000";
$(function(){
  $('#loginBtn').on('click', function(){
    const email = $('#email').val().trim();
    const password = $('#password').val();
    if(!email || !password){ $('#loginError').text('Please fill all fields.').removeClass('d-none'); return; }
    $('#loginError').addClass('d-none').text('');
    $.ajax({
      url: API_BASE + '/api/token/',
      method: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ username: email, password: password }),
    }).done(function(tokens){
      try { localStorage.setItem('access_token', tokens.access); localStorage.setItem('refresh_token', tokens.refresh); } catch(e) {}
      // Fetch organizations of the user and redirect to the first one
      $.ajax({
        url: API_BASE + '/api/v1/my-orgs/',
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + tokens.access }
      }).done(function(res){
        const results = (res && res.results) || [];
        if(results.length > 0){
          window.location.href = '/dashboard/' + encodeURIComponent(results[0].id);
        } else {
          $('#loginError').text('No organizations linked to this account.').removeClass('d-none');
        }
      }).fail(function(){
        $('#loginError').text('Unable to load organizations.').removeClass('d-none');
      });
    }).fail(function(xhr){
      let msg = 'Login failed';
      try { msg = (xhr.responseJSON && (xhr.responseJSON.detail || xhr.responseJSON.error)) || xhr.responseText || msg; } catch(e) {}
      $('#loginError').text(String(msg)).removeClass('d-none');
    });
  });
});
</script>
</body>
</html>


